@model IEnumerable<sistemaVeterinario.Models.Tratamiento>

@{
    ViewData["Title"] = "Tratamientos";
}

<h1>Tratamientos</h1>

<p>
    <a asp-action="Create" class="btn btn-success">Crear Nuevo Tratamiento</a>
</p>
<table class="table">
    <thead>
        <tr>
            <th>
                @Html.DisplayNameFor(model => model.Medicamento)
            </th>
            <th>
                @Html.DisplayNameFor(model => model.Descripcion)
            </th>
            <th>
                Consulta
            </th>
            <th></th>
        </tr>
    </thead>
    <tbody id="tratamientos-table-body">
@foreach (var item in Model) {
        <tr id="tratamiento-@item.IdTratamiento">
            <td>
                @Html.DisplayFor(modelItem => item.Medicamento)
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.Descripcion)
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.IdConsultaNavigation.MascotaYFecha)
            </td>
            <td>
                <a asp-action="Edit" asp-route-id="@item.IdTratamiento" class="btn btn-warning btn-sm">Editar</a> |
                <button class="btn btn-danger btn-sm btn-delete" data-id="@item.IdTratamiento" data-name="@item.Medicamento">Eliminar</button>
            </td>
        </tr>
}
    </tbody>
</table>

@section Scripts {
    <script>
        document.getElementById('tratamientos-table-body').addEventListener('click', function (event) {
            if (event.target && event.target.classList.contains('btn-delete')) {
                const tratamientoId = event.target.getAttribute('data-id');
                const tratamientoName = event.target.getAttribute('data-name');

                Swal.fire({
                    title: `¿Estás seguro de que quieres eliminar el tratamiento "${tratamientoName}"?`,
                    text: "¡No podrás revertir esto!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Sí, ¡bórralo!',
                    cancelButtonText: 'Cancelar'
                }).then((result) => {
                    if (result.isConfirmed) {
                        fetch(`/Tratamientos/Delete/${tratamientoId}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data === "ok") {
                                Swal.fire(
                                    '¡Borrado!',
                                    `El tratamiento "${tratamientoName}" ha sido eliminado.`,
                                    'success'
                                ).then(() => {
                                    const row = document.getElementById(`tratamiento-${tratamientoId}`);
                                    row.remove();
                                });
                            } else {
                                Swal.fire(
                                    'Error',
                                    'Ocurrió un error al eliminar el tratamiento.',
                                    'error'
                                );
                            }
                        });
                    }
                });
            }
        });
    </script>
}