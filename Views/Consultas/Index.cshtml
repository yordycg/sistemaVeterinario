@using sistemaVeterinario.Helpers
@model PaginatedList<sistemaVeterinario.Models.Consulta>

@{
    ViewData["Title"] = "Consultas";
}

<div class="card shadow mb-4">
    <div class="card-header py-3 d-flex align-items-center">
        <h1 class="h3 m-0 font-weight-bold text-primary text-center flex-grow-1">Gestión de Consultas</h1>
        <div class="ms-auto">
            <a asp-action="Create" class="btn btn-success btn-sm"><i class="bi bi-plus-lg me-2"></i>Agregar Consulta</a>
        </div>
    </div>
    <div class="card-body">
        <div class="text-end mt-3 mb-3">
            <form action="Index" method="get">
                <div class="input-group">
                    <input value="@ViewData["filtro"]" name="search" type="text" class="form-control" placeholder="Buscar..." aria-label="Recipient’s username" aria-describedby="button-addon2">
                    <button class="btn btn-outline-success" type="submit" id="button-addon2">Buscar</button>
                </div>
            </form>
        </div>
        <div class="table-responsive">
            <table class="table table-bordered table-hover" id="dataTable" width="100%" cellspacing="0">
                <thead class="table-dark text-center">
                    <tr>
                        <th>
                            Fecha Consulta
                        </th>
                        <th>
                            Estado
                        </th>
                        <th>
                            Mascota
                        </th>
                        <th>
                            Veterinario
                        </th>
                        <th>
                            Motivo
                        </th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="consultas-table-body">
@foreach (var item in Model) {
                    <tr id="consulta-@item.IdConsulta">
                        <td>
                            @Html.DisplayFor(modelItem => item.FechaConsulta)
                        </td>
                        <td>
                            @Html.DisplayFor(modelItem => item.IdEstadoConsultaNavigation.NombreEstado)
                        </td>
                        <td>
                            @Html.DisplayFor(modelItem => item.IdMascotaNavigation.Nombre)
                        </td>
                        <td>
                            @Html.DisplayFor(modelItem => item.IdUsuarioNavigation.Nombre)
                        </td>
                        <td>
                            @Html.DisplayFor(modelItem => item.Motivo)
                        </td>
                        <td class="text-center">
                            <a asp-action="Edit" asp-route-id="@item.IdConsulta" class="btn btn-icon-action btn-outline-warning btn-sm"><i class="bi bi-pencil me-0"></i></a>
                                @if (User.IsInRole("Admin") || User.IsInRole("Secretari@") || User.IsInRole("Veterinari@"))
                                {
                                <button class="btn btn-icon-action btn-outline-danger btn-sm btn-delete" data-id="@item.IdConsulta" data-name="Consulta del @item.FechaConsulta para @item.IdMascotaNavigation.Nombre"><i class="bi bi-trash me-0"></i></button>
                                }
                        </td>
                    </tr>
}
                </tbody>
            </table>
            @{
                var prev = !Model.HasPreviuosPage ? "disabled" : "";
                var next = !Model.HasNextPage ? "disabled" : "";
                var total = Model.TotalPages;
            }
            <nav aria-label="...">
                <ul class="pagination pagination-circle justify-content-center">
                    <li class="page-item @prev">
                        <a class="page-link" asp-action="Index" asp-route-pagNumber="@(Model.PageIndex-1)" asp-route-filter="@ViewData["filtro"]">Anterior</a>
                    </li>
                    @for (int i = 0; i < total; i++)
                    {
                        var activo = "";

                        if ((i + 1) == Model.PageIndex)
                        {
                            activo = "active";
                        }
                        <li class="page-item @activo">
                            <a class="page-link" asp-action="Index" asp-route-pagNumber="@(i+1)" asp-route-filter="@ViewData["filtro"]">@(i+1)</a>
                        </li>
                    }
                    <li class="page-item @next">
                        <a class="page-link" asp-action="Index" asp-route-pagNumber="@(Model.PageIndex+1)" asp-route-filter="@ViewData["filtro"]">Siguiente</a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.getElementById('consultas-table-body').addEventListener('click', function (event) {
            const deleteButton = event.target.closest('.btn-delete');
            if (deleteButton) {
                const consultaId = deleteButton.getAttribute('data-id');
                const consultaName = deleteButton.getAttribute('data-name');

                Swal.fire({
                    title: `¿Estás seguro de que quieres eliminar la ${consultaName}?`,
                    text: "¡No podrás revertir esto!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Sí, ¡bórrala!',
                    cancelButtonText: 'Cancelar'
                }).then((result) => {
                    if (result.isConfirmed) {
                        fetch(`/Consultas/Delete/${consultaId}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data === "ok") {
                                Swal.fire(
                                    '¡Borrada!',
                                    `La ${consultaName} ha sido eliminada.`, 
                                    'success'
                                ).then(() => {
                                    const row = document.getElementById(`consulta-${consultaId}`);
                                    row.remove();
                                });
                            } else if (data === "has_children") {
                                Swal.fire(
                                    'No se puede eliminar',
                                    `La ${consultaName} no puede ser eliminada porque tiene tratamientos asociados.`, 
                                    'error'
                                );
                            } else if (data === "notfound") {
                                Swal.fire(
                                    'Error',
                                    'La consulta no fue encontrada.',
                                    'error'
                                );
                            } else if (data === "error_db_constraint") {
                                Swal.fire(
                                    'Error de Base de Datos',
                                    `La ${consultaName} no puede ser eliminada debido a una restricción de la base de datos (posiblemente tiene registros asociados).`,
                                    'error'
                                );
                            } else {
                                Swal.fire(
                                    'Error',
                                    'Ocurrió un error inesperado al eliminar la consulta.',
                                    'error'
                                );
                            }
                        });
                    }
                });
            }
        });
    </script>
}