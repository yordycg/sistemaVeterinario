@model IEnumerable<sistemaVeterinario.Models.Usuario>

@{
    ViewData["Title"] = "Usuarios";
}

<div class="card shadow mb-4">
    <div class="card-header py-3 d-flex align-items-center">
        <h1 class="h3 m-0 font-weight-bold text-primary text-center flex-grow-1">Gestión de Usuarios</h1>
        <div class="ms-auto">
            <a asp-action="Create" class="btn btn-success btn-sm"><i class="bi bi-plus-lg me-2"></i>Agregar Usuario</a>
        </div>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-bordered table-hover" id="dataTable" width="100%" cellspacing="0">
                <thead class="table-dark text-center">
                    <tr>
                        <th>
                            @Html.DisplayNameFor(model => model.Nombre)
                        </th>
                        <th>
                            @Html.DisplayNameFor(model => model.Email)
                        </th>
                        <th>
                            @Html.DisplayNameFor(model => model.Password)
                        </th>
                        <th>
                            Estado
                        </th>
                        <th>
                            Rol
                        </th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="usuarios-table-body">
@foreach (var item in Model) {
                    <tr>
                        <td>
                            @Html.DisplayFor(modelItem => item.Nombre)
                        </td>
                        <td>
                            @Html.DisplayFor(modelItem => item.Email)
                        </td>
                        <td>
                            @Html.DisplayFor(modelItem => item.Password)
                        </td>
                        <td>
                            @Html.DisplayFor(modelItem => item.IdEstadoUsuarioNavigation.NombreEstado)
                        </td>
                        <td>
                            @Html.DisplayFor(modelItem => item.IdRolNavigation.NombreRol)
                        </td>
                        <td class="text-center">
                            <a asp-action="Edit" asp-route-id="@item.IdUsuario" class="btn btn-icon-action btn-outline-warning btn-sm"><i class="bi bi-pencil me-0"></i></a>
                            <button class="btn btn-icon-action btn-outline-danger btn-sm btn-delete" data-id="@item.IdUsuario" data-name="@item.Nombre"><i class="bi bi-trash me-0"></i></button>
                        </td>
                    </tr>
}
                </tbody>
            </table>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const tbody = document.getElementById('usuarios-table-body');
            if (tbody) {
                tbody.addEventListener('click', function (event) {
                    const deleteButton = event.target.closest('.btn-delete');
                    if (deleteButton) {
                        const usuarioId = deleteButton.getAttribute('data-id');
                        const usuarioName = deleteButton.getAttribute('data-name');

                        Swal.fire({
                            title: `¿Estás seguro de que quieres eliminar a ${usuarioName}?`,
                            text: "¡No podrás revertir esta acción!",
                            icon: 'warning',
                            showCancelButton: true,
                            confirmButtonColor: '#3085d6',
                            cancelButtonColor: '#d33',
                            confirmButtonText: 'Sí, ¡eliminar!',
                            cancelButtonText: 'Cancelar'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                fetch(`@Url.Action("Delete", "Usuarios")/${usuarioId}`, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    }
                                })
                                .then(response => response.json())
                                .then(data => {
                                    if (data === "ok") {
                                        Swal.fire(
                                            '¡Eliminado!',
                                            `El usuario ${usuarioName} ha sido eliminado.`, 
                                            'success'
                                        ).then(() => {
                                            location.reload(); // Recargar la página para reflejar el cambio
                                        });
                                    } else if (data === "has_children") {
                                        Swal.fire(
                                            'No se puede eliminar',
                                            `El usuario ${usuarioName} no puede ser eliminado porque tiene consultas asociadas.`, 
                                            'error'
                                        );
                                    } else if (data === "notfound") {
                                        Swal.fire(
                                            'Error',
                                            'El usuario no fue encontrado.',
                                            'error'
                                        );
                                    } else if (data === "error_db_constraint") {
                                        Swal.fire(
                                            'Error de Base de Datos',
                                            `El usuario ${usuarioName} no puede ser eliminado debido a una restricción de la base de datos (posiblemente tiene registros asociados).`,
                                            'error'
                                        );
                                    } else {
                                        Swal.fire(
                                            'Error',
                                            'Ocurrió un error inesperado al eliminar el usuario.',
                                            'error'
                                        );
                                    }
                                });
                            }
                        });
                    }
                });
            }
        });
    </script>
}
